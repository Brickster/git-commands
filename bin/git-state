#! /bin/bash

#
# A more concise and comprehensive version of `git status` and `git log` in one command.
#

#
# Echos text to strerr.
#
# $1: the text to echo
#
function error
{
    echo "$1" >&2
    exit 1
}

#
# Shows git-state man page.
#
function help
{
    man git-state
    exit 0
}

log_count=10
no_status=false
no_branches=false
no_stashes=false
while getopts ":hLSBTl:-:" opt; do
    case $opt in
        -)
            case "${OPTARG}" in
                log)
                    log_count="${!OPTIND}"
                    OPTIND=$(( $OPTIND + 1 ))
                    ;;
                full-log)       log_count=-1;;
                no-log)         log_count=0;;
                no-status)      no_status=true;;
                no-branches)    no_branches=true;;
                no-stashes)     no_stashes=true;;
                help)           help;;
                *)              error "Unimplemented option --${OPTARG}";;
            esac
            ;;
        l)  log_count="$OPTARG";;
        L)  log_count=0;;
        S)  no_status=true;;
        B)  no_branches=true;;
        T)  no_stashes=true;;
        h)  help;;
        \?) error "Invalid option: -$OPTARG";;
        *)  error "Unimplemented option: -$OPTARG";;
    esac
done

green='\x1B[0;32m'
nocolor='\x1B[0m'

# status
if ! $no_status; then
    git status --short --branch
fi

if (( $log_count != 0 )); then
    echo -e "## ${green}log${nocolor}"
    git log -n "$log_count" --oneline
fi

# branches
if ! $no_branches; then
    echo -e "## ${green}branches${nocolor}"
    git branch -v
fi

# stashes
if ! $no_stashes; then
    echo -e "## ${green}stashes${nocolor}"
    git stash list --oneline
fi
