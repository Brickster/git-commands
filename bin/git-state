#! /usr/bin/env python

import argparse

from commands import settings, state
from commands.utils.parse_actions import append_list, dict_set, optional_list


def main():

    # status defaults
    default_show_status = settings.get('git-state.status.show', default=True, as_type=settings.as_bool)

    # general defaults
    default_show_empty = settings.get('git-state.show-empty', default=False, as_type=settings.as_bool)
    default_format = settings.get('git-state.format', default='compact')
    default_show_color = settings.get('color.ui', default='auto')
    default_clear = settings.get('git-state.clear', default=True, as_type=settings.as_bool)

    parser = argparse.ArgumentParser(
        prog='git state',
        version='git-state 0.5.0',
        description=state.__doc__,
        epilog='for more detail, use: git help state'
    )

    # status
    status_group = parser.add_mutually_exclusive_group()
    status_group.add_argument(
        '-s',
        '--status',
        help='show status section',
        action='store_true',
        dest='show_status',
        default=default_show_status
    )
    status_group.add_argument(
        '-S',
        '--no-status',
        help='hide status section',
        action='store_false',
        dest='show_status'
    )

    # add --show-/--no-show- flags for custom extensions
    extensions = settings.list(
        section='git-state.extensions',
        config=None,
        count=False,
        keys=True,
        format=None,
        file=None
    ).splitlines()
    for extension in extensions:
        extension_group = parser.add_mutually_exclusive_group()
        section_name = settings.get('git-state.extensions.' + extension + '.name', default=extension)
        extension_group.add_argument(
            '--show-' + extension,
            help='show {} extension'.format(section_name),
            action=append_list(extension),
            nargs=0,
            dest='show_extensions',
            default=[]
        )
        extension_group.add_argument(
            '--no-show-' + extension,
            help='hide {} extension'.format(section_name),
            action=append_list(extension),
            nargs=0,
            dest='ignore_extensions',
            default=[]
        )

    # color
    color_group = parser.add_mutually_exclusive_group()
    color_group.add_argument(
        '-c',
        '--color',
        help='color output',
        const='always',
        dest='show_color',
        nargs='?',
        choices=('always', 'never', 'auto'),
        default=default_show_color
    )
    color_group.add_argument(
        '-C',
        '--no-color',
        help='never color output',
        action='store_const',
        const='never',
        dest='show_color'
    )

    # format
    format_group = parser.add_mutually_exclusive_group()
    format_group.add_argument(
        '-f',
        '--format',
        help='format the each section (choices: compact, pretty)',
        choices=('pretty', 'compact'),
        metavar='FORMAT',
        dest='format',
        default=default_format
    )
    format_group.add_argument(
        '-p',
        '--pretty',
        help='show in pretty format',
        action='store_const',
        const='pretty',
        dest='format'
    )

    # show empty
    show_empty_group = parser.add_mutually_exclusive_group()
    show_empty_group.add_argument(
        '-e',
        '--show-empty',
        help='show empty sections',
        action='store_true',
        dest='show_empty',
        default=default_show_empty
    )
    show_empty_group.add_argument(
        '-E',
        '--no-show-empty',
        help="don't show empty sections (does not apply to status)",
        action='store_false',
        dest='show_empty'
    )

    # screen clearing
    clear_group = parser.add_mutually_exclusive_group()
    clear_group.add_argument(
        '--clear',
        help='clear the screen before printing',
        action='store_true',
        dest='clear',
        default=default_clear
    )
    clear_group.add_argument(
        '--no-clear',
        help='do not clear the screen before printing',
        action='store_false',
        dest='clear'
    )

    # ignore sections
    parser.add_argument(
        '--ignore-extensions',
        help='a list of extensions to ignore',
        nargs='*',
        action=optional_list(settings.list(
            'git-state.extensions',
            config=None,
            count=False,
            keys=True,
            format=None
        ).splitlines()),
        default=[],
        metavar='EXTENSION'
    )

    parser.add_argument(
        '-o',
        '--order',
        help='custom section order',
        nargs='+',
        default=argparse.SUPPRESS,
        metavar='SECTION'
    )

    parser.add_argument(
        '-O',
        '--options',
        help='options to pass to custom extensions',
        nargs='+',
        default={},
        action=dict_set(':'),
        metavar='OPTION'
    )

    state.state(**vars(parser.parse_args()))

if __name__ == '__main__':
    main()
