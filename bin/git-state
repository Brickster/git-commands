#! /bin/bash

#
# A more concise and comprehensive version of `git status` and `git log` in one command.
#

#
# Echos text to strerr.
#
# $1: the text to echo
#
function error
{
    echo "$1" >&2
    exit 1
}

#
# Shows git-state man page.
#
function help
{
    man git-state
    exit 0
}

#
# Determines whether there are stashes or not
#
function stash_not_empty
{
    stashes=$(git stash list 2>&1)
    IFS=$'\n' read -rd '' -a stashes <<< "$stashes"

    if (( ${#stashes[@]} == 0 )); then
        return 1
    fi
    return 0
}

#
# Echos a section of the state.
#
# Optionally, the output can be echoed in pretty format. Pretty format includes pre- and a- pended newlines 
# as well as tabs starting every line.
#
# $1: the section title
# $2: the text to pretty print
# $3: whether the section should be echoed in pretty format
#
function echo_section
{
    title="$1"
    text="$2"
    use_pretty="$3"

    echo -e "## ${green}$title${nocolor}"
    if $use_pretty; then

        IFS=$'\n' read -rd '' -a text <<< "$text"
        tab="    "

        echo
        count=${#text[@]}
        for ((i=0;i<count;i++)); do
            echo "$tab${text[i]}"
        done
        echo
    else
        echo -e "$text"
    fi
}

green='\x1B[0;32m'
nocolor='\x1B[0m'

log_count=10
no_status=false
no_branches=false
no_stashes=false
show_empty=false
color="always"
pretty=false
while getopts ":hpcCeLSBTl:-:" opt; do
    case $opt in
        -)
            case "${OPTARG}" in
                log)
                    log_count="${!OPTIND}"
                    OPTIND=$(( $OPTIND + 1 ))
                    ;;
                full-log)       log_count=-1;;
                no-log)         log_count=0;;
                no-status)      no_status=true;;
                no-branches)    no_branches=true;;
                no-stashes)     no_stashes=true;;
                show-empty)     show_empty=true;;
                color)          color="always";;
                pretty)         pretty=true;;
                no-color)
                    color="never"
                    green=""
                    nocolor=""
                    ;;
                help)           help;;
                *)              error "Unimplemented option --${OPTARG}";;
            esac
            ;;
        c)  color="always";;
        C)
            color="never"
            green=""
            nocolor=""
            ;;
        e)  show_empty=true;;
        l)  log_count="$OPTARG";;
        L)  log_count=0;;
        S)  no_status=true;;
        B)  no_branches=true;;
        T)  no_stashes=true;;
        p)  pretty=true;;
        h)  help;;
        \?) error "Invalid option: -$OPTARG";;
        *)  error "Unimplemented option: -$OPTARG";;
    esac
done

# status
if ! $no_status; then
    # make sure status will output ANSI codes
    # this must be done using config since status has no --color option
    status_color=$(git config color.status)
    git config color.status "$color"

    git status --short --branch

    # reset color.status to its original setting
    if [[ -z "$status_color" ]]; then
        git config --unset color.status
    else
        git config color.status "$status_color"
    fi
fi

if (( $log_count != 0 )); then
    log_output=$(git log -n "$log_count" --oneline --color="$color")
    echo_section "log" "$log_output" "$pretty"
fi

# branches
if ! $no_branches; then
    branch_output=$(git branch -v --color="$color")
    echo_section "branches" "$branch_output" "$pretty"
fi

# stashes
if ! $no_stashes && ( $show_empty || stash_not_empty ); then
    stash_output=$(git stash list --oneline --color="$color")
    echo_section "stashes" "$stash_output" "$pretty"
fi
