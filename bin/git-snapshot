#! /bin/bash

function main
{
    message=
    while getopts ":hm:-:" opt; do
        case $opt in
            -)
                case "${OPTARG}" in
                    message)
                        message="${!OPTIND}"
                        OPTIND=$(( $OPTIND + 1 ))
                        ;;
                    help)
                        help
                        ;;
                    *)
                        error "Unimplemented option --${OPTARG}"
                        ;;
                esac
                ;;
            m)  message="$OPTARG";;
            h)  help;;
            \?) error "Invalid option: -$OPTARG";;
            :)  error "Option -$OPTARG requires an argument.";;
            *)  error "Unimplemented option: -$OPTARG";;
        esac
    done

    # get the last snapshot ID
    stashs=$(git stash list 2>&1)
    IFS=$'\n' read -rd '' -a stashs <<< "$stashs"
    max_stash_id=-1
    for stash in "${stashs[@]}"
    do
        regex="^.*snapshot\@\{([[:digit:]]+)\}.*$"
        if [[ $stash =~ $regex ]]; then
            if (( "$max_stash_id" < "${BASH_REMATCH[1]}" )); then
                max_stash_id="${BASH_REMATCH[1]}"
            fi
        fi
    done

    if [[ -z "$message" ]]; then
        # no message, use the last commit
        message=$(git log -1 --oneline)
    fi

    ((max_stash_id++))
    git stash save -u --quiet "snapshot@{$max_stash_id} $message" 
    git stash apply --quiet > /dev/null 2>&1 # apply won't shut up so swallow the output
}

#
# Deletes a snapshot.
#
# $1: the snapshot to delete
#
function delete
{
    snapshot="$2"

    if [[ -z "$snapshot" ]]; then
        error 'A snapshot must be specified using "git snapshot delete <snapshot>"'
    fi

    stashs=$(git stash list 2>&1)
    IFS=$'\n' read -rd '' -a stashs <<< "$stashs"

    for ((i=0; i<${#stashs[@]}; i++)); do
        stash=${stashs[i]}
        if [[ $stash =~ ^.*"$snapshot".*$ ]]; then
            git stash drop stash@{$i} --quiet
            echo "Deleted $snapshot"
            exit 0
        fi
    done

    exit 0
}

#
# Echos text to strerr.
#
# $1: the text to echo
#
function error
{
    echo "$1" >&2
    exit 1
}

#
# Shows git-snapshot man page.
#
function help
{
    man git-snapshot
    exit 0
}

#
# Clears all snapshots.
#
function clear
{
    stashs=$(git stash list 2>&1)
    IFS=$'\n' read -rd '' -a stashs <<< "$stashs"

    count=0
    total=${#stashs[@]}
    for stash in "${stashs[@]}"
    do
        if [[ $stash =~ ^.*snapshot\@\{[[:digit:]]+\}.*$ ]]; then
            git stash drop stash@{$count} --quiet
            clear # recurse
        fi
        ((count++))
    done

    exit 0
}

#
# Lists all snapshots.
#
function list
{
    stashs=$(git stash list 2>&1)
    IFS=$'\n' read -rd '' -a stashs <<< "$stashs"

    count=0
    for stash in "${stashs[@]}"
    do
        if [[ $stash =~ ^.*snapshot\@\{[[:digit:]]+\}.*$ ]]; then
            echo "$stash"
        fi
    done
    exit 0
}

if [[ "$1" == "clear" ]]; then
    clear
elif [[ "$1" == "list" ]]; then
    list
elif [[ "$1" == "delete" ]]; then
    delete "$@"
fi
main "$@"
