#! /usr/bin/env python

import argparse
import os
import sys

from commands import settings, tuck

# specific usage message needed to include the '--' part
_USAGE_MESSAGE = 'git tuck [MESSAGE] [-h] [-v] [-i|-I] [-q] -- FILE [FILE ...]'

parser = argparse.ArgumentParser(
    prog='git tuck',
    version='git-tuck 0.1.0',
    usage=_USAGE_MESSAGE,
    description=tuck.__doc__,
    epilog='for more detail, use: git help tuck'
)

parser.add_argument('message', help='message used when stashing the files', nargs='?', metavar='MESSAGE')

# -- <files> ...
# NOTE: this is so the files argument is listed in the argparse output. All file arguments are handled manually.
parser.add_argument('files', help='files to stash', nargs='?', metavar='FILE')

# -q|--quiet
parser.add_argument(
    '-q',
    '--quiet',
    help='suppress all non-error output',
    action='store_true',
    default=False
)

# -i|--ignore-deleted
ignored_deleted_group = parser.add_mutually_exclusive_group()
ignored_deleted_group.add_argument(
    '-i',
    '--ignore-deleted',
    help="don't print the error message for deleted files not explicitly included",
    action='store_true',
    default=settings.get('git-tuck.ignore-deleted', default=False, as_type=settings.as_bool)
)
ignored_deleted_group.add_argument(
    '-I',
    '--no-ignore-deleted',
    help="don't print the error message for deleted files not explicitly included",
    action='store_false',
    dest='ignore_deleted'
)

# check for args that match the format: '-- <files> [<files> ..]
args = sys.argv[1:]
file_args = []
if '--' in args:
    delimiter_index = args.index('--') if '--' in args else len(args)
    file_args = args[delimiter_index + 1:]
    args = args[:delimiter_index]

args = parser.parse_args(args)
args.files = file_args
if not args.files:
    sys.exit('usage: {}{}git tuck: error: at least one file must be included'.format(_USAGE_MESSAGE, os.linesep))

tuck.tuck(**vars(args))
