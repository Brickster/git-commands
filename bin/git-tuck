#! /usr/bin/env python

import argparse
import sys

from commands import settings, tuck

# specific usage message needed to include the '--' part
_USAGE_MESSAGE = 'git tuck [-h] [-v] [-m MESSAGE] [-i|-I] [-q] -- <file> [<file> ...]'

parser = argparse.ArgumentParser(
    prog='git tuck',
    version='git-tuck 0.1.0',
    usage=_USAGE_MESSAGE,
    description=tuck.__doc__,
    epilog='for more detail, use: git help tuck'
)

# --message <message>
parser.add_argument(
    '-m',
    '--message',
    metavar='<message>',
    help='message used when stashing the files'
)

# -- <files> ..
parser.add_argument(
    help='files to stash',
    nargs=argparse.REMAINDER,
    metavar='<files>',
    dest='files'
)

# -q|--quiet
parser.add_argument(
    '-q',
    '--quiet',
    help='suppress all non-error output',
    action='store_true',
    default=False
)

# -i|--ignore-deleted
ignored_deleted_group = parser.add_mutually_exclusive_group()
ignored_deleted_group.add_argument(
    '-i',
    '--ignore-deleted',
    help="don't print the error message for deleted files not explicitly included",
    action='store_true',
    default=settings.get('git-tuck.ignore-deleted', default=False, as_type=settings.as_bool)
)
ignored_deleted_group.add_argument(
    '-I',
    '--no-ignore-deleted',
    help="don't print the error message for deleted files not explicitly included",
    action='store_false',
    dest='ignore_deleted'
)

# check that the remaining args match the format: '-- <files> [<files> ..]
args = parser.parse_args()
if args.files and len(args.files) > 1:
    if args.files[0] != '--':
        sys.exit('usage: {}\ngit tuck: error: unrecognized arguments: {}'.format(_USAGE_MESSAGE, ' '.join(args.files)))
    args.files = args.files[1:]
else:
    sys.exit('git tuck: error: at least one file must be included to stash')

tuck.tuck(**vars(args))
