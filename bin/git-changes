#! /usr/bin/env python

import getopt
import sys

from subprocess import call, check_output
from utils.help import man
from utils.messages import version, error, usage, info


def get_changes(count, branch):
    '''Print the changes between a given branch and HEAD'''

    command = ['git', 'log', '--oneline', '{}..HEAD'.format(branch)]
    if count:
        log = check_output(command)
        log = log.splitlines()
        info(len(log))
    else:
        call(command)


def main(argv):
    try:
        opts, left_args = getopt.getopt(argv, "hvcb:", ["help", "version", "count", "branch="])
    except getopt.GetoptError as e:
        error(e.msg, exit=False)
        usage(["git changes [(-b |--branch=)<branch>] [(-c|--count)]", "git changes (-h|--help)", "git changes (-v|--version)"])

    branch = check_output(['git', 'settings', '-d', 'master', 'git-changes.default-branch']).splitlines()[0]
    count = False
    for opt, arg in opts:
        if opt in ('-h', '--help'):
            man()
        elif opt in ('-v', '--version'):
            version('0.1.0')
        elif opt in ('-c', '--count'):
            count = True
        elif opt in ('-b', '--branch'):
            branch = arg

    get_changes(count, branch)

if __name__ == "__main__":
    main(sys.argv[1:])
