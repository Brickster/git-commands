#! /usr/bin/env python

import argparse

from commands import changes, upstream
from subprocess import check_output
from utils.parse_actions import flag_as_value


def main():

    parser = argparse.ArgumentParser(
        prog="git changes",
        version="git-changes 0.2.0",
        description="list the commits between this branch and another",
        epilog="for more detail, use: git help changes"
    )

    # -b|--branch
    default_branch = check_output(['git', 'settings', 'get', '-d', 'master', 'git-changes.default-branch']).splitlines()[0]
    branch_group = parser.add_mutually_exclusive_group()
    branch_group.add_argument(
        "-b",
        "--branch",
        help="show the commits between HEAD and <branch>",
        metavar="<branch>",
        default=default_branch
    )

    # -r|--remote
    branch_group.add_argument(
        '-r',
        '--remote',
        help='show the commits between the local and remote head',
        action=flag_as_value(upstream.upstream(True)),
        nargs=0,
        dest='branch'
    )

    details_group = parser.add_mutually_exclusive_group()

    # -c|--count
    details_group.add_argument(
        "-c",
        "--count",
        help="show as a count of changes",
        action=flag_as_value("count"),
        dest="details",
        nargs=0
    )

    # -s|--stat
    details_group.add_argument(
        "-s",
        "--stat",
        help="show as a diffstat",
        action=flag_as_value("stat"),
        dest="details",
        nargs=0
    )

    # -d|--diff
    details_group.add_argument(
        "-d",
        "--diff",
        help="show as a full diff",
        action=flag_as_value("diff"),
        dest="details",
        nargs=0
    )

    changes.changes(**vars(parser.parse_args()))

if __name__ == "__main__":
    main()
